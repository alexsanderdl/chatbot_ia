<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Preparat√≥rio Anbima & Certifica√ß√µes ‚Äî CPA-10 / CPA-20 / CEA / CFG / CGA / CGE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Paleta clara e chamativa */
            --bg-start: #f0fff6; /* topo do fundo (claro) */
            --bg-end:   #eef7ff; /* base do fundo (claro) */
            --bg: linear-gradient(180deg,var(--bg-start) 0%, var(--bg-end) 70%);

            --card:#ffffff; /* cart√£o principal */
            --text:#0b1220; /* texto principal escuro */
            --muted:#6b7280; /* texto secund√°rio */

            --accent:#64c832; /* verde solicitado */
            --accent-2:#8fe56b; /* verde claro */
            --user-bg:linear-gradient(135deg,var(--accent),var(--accent-2));
            --ai-bg:linear-gradient(135deg,#e6fbef,#f2fff6);

            /* chat area gradient mais vis√≠vel */
            --chat-start: #ffffff;
            --chat-end:   #f0fff4;
            --chat-bg: linear-gradient(180deg,var(--chat-start) 0%, var(--chat-end) 60%);

            --controls-bg: rgba(255,255,255,0.02);
            --controls-border: rgba(16,24,40,0.04);
            --btn-shadow: 0 6px 18px rgba(100,200,50,0.08);

            /* cor do bot√£o lixeira (secondary) - tema claro/escuro controlado via vars */
            --clear-color: #1f2937; /* escuro, para tema claro */
            --clear-border: rgba(16,24,40,0.06);
            --clear-hover: rgba(31,41,55,0.06);

            /* send button gradient */
            --send-bg: linear-gradient(90deg,var(--accent),var(--accent-2));
            --send-text: #ffffff;
            --send-hover: 0 8px 20px rgba(100,200,50,0.14);

            --radius:12px;
            --transition:all 0.18s ease;
        }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes slideIn { from { transform:translateY(10px); opacity:0; } to { transform:translateY(0); opacity:1; } }
        @keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.05); } 100% { transform:scale(1); } }

        /* Reset e base */
        * { box-sizing:border-box; }
        html, body { 
            height:100%; margin:0; 
            font-family:'Inter',system-ui,-apple-system,sans-serif; 
            color:var(--text);
                background: var(--bg);
                transition: background 0.3s ease, color 0.25s ease;
        }

        .container {
            /* Usar ainda mais espa√ßo lateral em telas grandes, mantendo
               responsividade em telas menores */
            max-width:1400px;
            width:calc(100% - 48px); /* reduz margem lateral total de 64px -> 48px */
            margin:16px auto;
            padding:22px 32px;
            background:var(--card);
            border-radius:18px;
            box-shadow:0 10px 30px rgba(16,24,40,0.06);
            animation:fadeIn 0.36s ease-out;
        }

        /* Layout com painel lateral */
        .body-grid{
            display:flex;
            gap:36px; /* mais espa√ßo entre chat e guia */
            align-items:flex-start;
        }

        aside#study-sidebar{
            width:360px;
            flex:0 0 360px;
            background:var(--card);
            border-radius:12px;
            padding:14px;
            border:1px solid var(--controls-border);
            max-height:72vh;
            overflow:auto;
        }

          /* Permite que a √°rea principal (chat) cres√ßa para ocupar o espa√ßo
              horizontal restante e define uma largura m√≠nima razo√°vel. */
          main#chat-wrap{ flex:1; min-width:480px; }

        .sidebar-title{font-weight:700;margin:6px 0 10px 0}
        .cert-item{border-bottom:1px dashed rgba(0,0,0,0.04);padding:8px 0}
        .cert-item button.toggle-cert{background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:600}
    .module-list{margin:8px 0 0 0;padding-left:14px}
        .module{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
        .module button{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--muted)}
        .module button.start{background:var(--send-bg);color:var(--send-text);border:none}

        @media (max-width:900px){
            .body-grid{flex-direction:column}
            aside#study-sidebar{width:100%;flex:0 0 auto;max-height:none}
        }

        /* Header com logo animado */
        header { 
            display:flex;
            align-items:center;
            gap:16px;
            margin-bottom:18px;
            padding:10px 12px;
            border-radius:12px;
        }

        .logo-wrap {
            width:52px;
            height:52px;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:12px;
            /* agora a logo usa o mesmo gradiente do bot√£o enviar */
            background: var(--send-bg);
            box-shadow:0 6px 18px rgba(100,200,50,0.12);
            transition:var(--transition);
        }

        .logo-wrap:hover {
            transform:scale(1.05);
            box-shadow:0 6px 20px rgba(100,200,50,0.18);
        }

        .logo-wrap svg {
            width:28px;
            height:28px;
            fill:white;
        }

        header h1 { 
            font-size:20px;
            font-weight:600;
            margin:0;
            color:var(--text);
        }

        header p { 
            margin:0;
            color:var(--muted);
            font-size:13px;
        }

        

        /* Remover sublinhado/foco indesejado em links que usam a mesma classe */
        .theme-toggle:link, .theme-toggle:visited { text-decoration:none }
        .theme-toggle svg{width:16px;height:16px}

        /* ANBIMA logo dentro do controle do cabe√ßalho */
        .theme-toggle img.anbima-logo{
            height:16px;
            width:auto;
            display:inline-block;
            margin-right:6px;
            border-radius:4px;
        }

        /* estilo para o link ANBIMA espec√≠fico (ajusta gap e alinhamento) */
    .anbima-link{ display:inline-flex; align-items:center; gap:6px; }
    /* aproxima a logo ANBIMA do bot√£o de tema quando este for compacto */
    .anbima-link + .theme-toggle.icon-only{ margin-left:4px; }

        /* bot√£o de tema somente √≠cone (circular) */
        /* compact circular theme button: size matched to icon */
        .theme-toggle.icon-only{               
            width:28px; /* smaller circle so it n√£o pare√ßa exagerado */
            height:28px;
            padding:0;
            border-radius:50%;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            line-height:0; /* evita alinhamento de linha que estica */
            border:1px solid rgba(16,24,40,0.06);
            background:transparent;
            transition: var(--transition);
        }
        .theme-toggle.icon-only span{ display:none; }
        .theme-toggle.icon-only svg{ width:16px; height:16px; stroke-width:1; display:block; }
        /* reduz o padding interno do svg para evitar que pare√ßa esticado */
        .theme-toggle.icon-only svg circle, .theme-toggle.icon-only svg path{ vector-effect:non-scaling-stroke; }
    /* mostrar lua quando estiver em .dark, sol quando n√£o */
    .theme-toggle.icon-only .icon-sun{ display:inline-block; }
    .theme-toggle.icon-only .icon-moon{ display:none; color:var(--muted); }
    body.dark .theme-toggle.icon-only .icon-sun{ display:none; }
    body.dark .theme-toggle.icon-only .icon-moon{ display:inline-block; color:var(--muted); }

        /* hover grow/raise effect: aplica mesma sensa√ß√£o de 'crescer' dos bot√µes */
        .theme-toggle.icon-only:hover,
        .anbima-link:hover{
            transform: translateY(-1px) scale(1.03);
            box-shadow: 0 8px 20px rgba(100,200,50,0.14);
        }

        /* Chat √°rea com avatares e bolhas melhoradas */
        #chat-wrap { 
            display:flex;
            flex-direction:column;
            gap:16px;
        }

        #chat-box {
            background: var(--chat-bg);
            padding:18px;
            border-radius:12px;
            min-height:320px;
            max-height:55vh;
            overflow:auto;
            border:1px solid var(--controls-border);
            scroll-behavior:smooth;
        }

        /* Perguntas r√°pidas (chips) acima do campo de escrita */
        .quick-questions{
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            margin:10px 0 6px 0;
        }

        .quick-questions .chip{
            background:transparent;
            border:1px solid rgba(16,24,40,0.06);
            color:var(--muted);
            padding:6px 10px;
            border-radius:999px;
            cursor:pointer;
            font-size:13px;
            transition:all 0.16s ease;
        }

        .quick-questions .chip:hover{
            transform:translateY(-2px);
            border-color:var(--accent-2);
            color:var(--accent);
            background:rgba(100,200,50,0.06);
        }

        .msg-wrap {
            display:flex;
            gap:12px;
            margin-bottom:16px;
            opacity:0;
            animation:slideIn 0.3s ease-out forwards;
        }

        .avatar {
            width:38px;
            height:38px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            flex-shrink:0;
            transition:var(--transition);
        }

        .avatar svg {
            width:24px;
            height:24px;
            fill:currentColor;
        }

        .user .avatar {
            background:var(--accent);
            color:white;
            margin-left:12px;
            order:2;
        }

        .ai .avatar {
            background:var(--ai-bg);
            color:white;
        }

        .msg {
            position:relative;
            max-width:75%;
            padding:12px 16px;
            border-radius:14px;
            line-height:1.4;
            color:var(--text);
            word-wrap:break-word;
            transition:var(--transition);
        }

        .msg:hover {
            transform:translateY(-1px);
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
        }

        .meta {
            display:block;
            font-size:11px;
            color:var(--muted);
            margin-top:6px;
            opacity:0.8;
        }

        .user {
            flex-direction:row-reverse;
        }

        .user .msg {
            background:var(--user-bg);
            color:white;
            border-radius:16px 16px 4px 16px;
            margin-right:12px;
        }

        .ai .msg {
            background:var(--ai-bg);
            color:var(--text);
            border-radius:16px 16px 16px 4px;
            margin-left:12px;
        }

        .system {
            justify-content:center;
        }

        .system .msg {
            background:rgba(255,255,255,0.05);
            color:var(--muted);
            font-size:13px;
            border-radius:12px;
            max-width:85%;
            text-align:center;
        }

        .error .msg {
            background:#ffe6e6;
            color:#7a1212;
            border-radius:12px;
            padding:12px 16px;
            border-left:4px solid #dc2626;
        }

        /* Input area com bot√µes animados */
        .controls {
            display:flex;
            gap:12px;
            align-items:flex-end;
            margin-top:16px;
            padding:16px;
            border-radius:16px;
            background:var(--controls-bg);
            border:1px solid var(--controls-border);
        }

        .input-area {
            flex:1;
            display:flex;
            gap:12px;
        }

        .input-area textarea {
            flex:1;
            resize:vertical;
            min-height:48px;
            max-height:220px;
            padding:12px 14px;
            border-radius:12px;
            border:1px solid rgba(16,24,40,0.06);
            background:transparent;
            color:var(--text);
            font-size:15px;
            transition:var(--transition);
        }

        .input-area textarea:focus {
            outline:none;
            border-color:var(--accent);
            background:rgba(255,255,255,0.04);
            box-shadow:0 0 0 4px rgba(100,200,50,0.12);
        }

        .btn {
            display:inline-flex;
            align-items:center;
            gap:8px;
            background:var(--send-bg);
            color:var(--send-text);
            border:none;
            padding:10px 16px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            font-size:14px;
            transition:var(--transition);
            box-shadow:var(--btn-shadow);
        }

        .btn svg {
            width:18px;
            height:18px;
            transition:var(--transition);
        }

        /* √çcones dos bot√µes (enviar / limpar) usam a mesma cor do texto mutado (lua) */
        .btn svg, .btn svg * {
            fill: var(--muted);
            stroke: var(--muted);
        }

        .btn:hover {
            transform:translateY(-1px);
            box-shadow:0 8px 20px rgba(100,200,50,0.14);
        }

        .btn:hover svg {
            transform:scale(1.1);
        }

        .btn:active {
            transform:translateY(1px);
        }

        .btn.secondary {
            background:transparent;
            border:1px solid var(--clear-border);
            color:var(--clear-color);
        }

        .btn.secondary:hover {
            background:var(--clear-hover);
            box-shadow:none;
        }

        .btn:disabled {
            opacity:0.6;
            cursor:not-allowed;
            transform:none;
        }

        /* small helpers */
        .server-url{font-size:12px;color:var(--muted)}
        .typing{font-style:italic;color:var(--muted)}

        /* Dark theme (applied when body has .dark) */
        .dark {
            --bg-start: #06111a; /* topo escuro */
            --bg-end:   #071827; /* base escuro */
            --bg: linear-gradient(180deg,var(--bg-start) 0%, var(--bg-end) 70%);

            --card:#07121a;
            --text:#e6eef8;
            --muted:#94a3b8;

            --accent:#64c832;
            --accent-2:#8fe56b;
            --user-bg:linear-gradient(135deg,var(--accent),var(--accent-2));
            --ai-bg:linear-gradient(135deg,#063c23,#0b6a3a);

            --chat-start: #051018;
            --chat-end:   #071827;
            --chat-bg: linear-gradient(180deg,var(--chat-start) 0%, var(--chat-end) 70%);

            --controls-bg: rgba(255,255,255,0.02);
            --controls-border: rgba(255,255,255,0.03);
            --btn-shadow: 0 6px 18px rgba(50,100,30,0.04);

            /* no tema escuro a lixeira fica em tom mais claro (ajustado) */
            --clear-color: #e6eef8; /* cinza bem claro para icon/borda em dark */
            --clear-border: rgba(230,238,248,0.08);
            --clear-hover: rgba(230,238,248,0.06);

            --send-bg: linear-gradient(90deg,#2f6f2a,#1f5f20);
            --send-text: #ffffff;
        }

        @media (max-width:600px){.container{margin:12px;padding:14px}.user,.ai{max-width:92%}}
    </style>
</head>
<body>
    <!-- SVG Sprites (√≠cones) -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <symbol id="anbima-mark" viewBox="0 0 24 24">
            <!-- Marca estilizada simples (monograma A) usada como √≠cone no bot√£o -->
            <circle cx="12" cy="12" r="10" fill="currentColor" />
            <path d="M8 15 L12 7 L16 15 Z" fill="white" />
        </symbol>
        <symbol id="robot" viewBox="0 0 24 24">
            <!-- mantenho robot como avatar alternativo (simbolica) -->
            <path d="M6 2h11a2 2 0 0 1 2 2v15a1 1 0 0 1-1 1H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 2v13.5L12 15l6 2.5V4H6z"/>
        </symbol>
        <symbol id="mortar" viewBox="0 0 24 24">
            <!-- √≠cone simples de chap√©u de formatura (mortarboard) -->
            <path d="M12 2 1 7l11 5 9-4-9-4zM5 9.2V12c0 2.8 3.6 4.7 7 5.8 3.4-1.1 7-3 7-5.8v-2.8L12 13 5 9.2z"/>
        </symbol>
        <symbol id="user" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3s-3-1.34-3-3s1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22c.03-1.99 4-3.08 6-3.08c1.99 0 5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z"/>
        </symbol>
        <symbol id="send" viewBox="0 0 24 24">
            <path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12L2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91z"/>
        </symbol>
        <symbol id="clear" viewBox="0 0 24 24">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12l1.41 1.41L13.41 14l2.12 2.12l-1.41 1.41L12 15.41l-2.12 2.12l-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"/>
        </symbol>
    </svg>

    <div class="container">
        <header>
            <div class="logo-wrap" aria-hidden="true">
                <!-- logo: chap√©u de formatura (mortarboard) -->
                <svg aria-hidden="true"><use href="#mortar"/></svg>
            </div>
            <div>
                <h1>Preparat√≥rio Anbima & Certifica√ß√µes  </h1>
                <p>Simulados e explica√ß√µes para CPA-10, CPA-20, CEA, CFG, CGA e CGE ‚Äî ferramenta para quem estuda para certifica√ß√µes Anbima e correlatas.</p>
                <p class="assistant-credit"> Alexsander Duarte</p>
            </div>
            <div style="margin-left:auto;text-align:right">
                <!-- Removido: exibi√ß√£o da URL da API e texto de atalho para manter a UI limpa -->
                <!-- Linha com link para Anbima e bot√£o de tema lado a lado -->
                <div style="display:flex;flex-direction:row;gap:8px;align-items:center;justify-content:flex-end">
                    <a class="theme-toggle anbima-link" href="https://www.anbima.com.br/pt_br/institucional/certificacao.htm" target="_blank" rel="noopener noreferrer" title="Ir para a p√°gina de certifica√ß√µes da Anbima">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/ANBIMA.svg/1200px-ANBIMA.svg.png" alt="ANBIMA" class="anbima-logo"/>
                    </a>
                    <button id="theme-toggle" class="theme-toggle icon-only" aria-pressed="false" title="Alternar tema claro/escuro" aria-label="Alternar tema">
                        <!-- Sol (aparece em tema claro) -->
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3.5"></circle><path d="M12 2v2M12 20v2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M2 12h2M20 12h2M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>
                        <!-- Lua (aparece no tema escuro) -->
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3A7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <div class="body-grid">
            <main id="chat-wrap">
            <div id="chat-box">
                    <div class="msg-wrap system">
                    <div class="msg">
                        <span style="color:#9be7ef">üëã Bem-vindo!</span><br>
                        Sou um assistente para ajud√°-lo a estudar para certifica√ß√µes Anbima e correlatas (CPA-10, CPA-20, CEA, CFG, CGA, CGE).<br>
                        Pe√ßa quest√µes de simulado, explica√ß√µes de conceitos (juros, renda fixa, fundos), quest√µes por certifica√ß√£o ou planos de estudo.
                    </div>
                </div>
            </div>

            <!-- Perguntas r√°pidas para ajudar o usu√°rio a come√ßar -->
            <div class="quick-questions" aria-hidden="false">
                <button class="chip" data-q="Gere 10 quest√µes no estilo CPA-10 com gabarito e breve explica√ß√£o:">Gerar 10 quest√µes CPA‚Äë10</button>
                <button class="chip" data-q="Gere 10 quest√µes no estilo CPA-20 com gabarito e breve explica√ß√£o:">Gerar 10 quest√µes CPA‚Äë20</button>
                <button class="chip" data-q="Gere 10 quest√µes no estilo CEA com gabarito e breve explica√ß√£o:">Gerar 10 quest√µes CEA</button>
                <button class="chip" data-q="Gere 10 quest√µes no estilo CFG com gabarito e breve explica√ß√£o:">Gerar 10 quest√µes CFG</button>
                <button class="chip" data-q="Gere 10 quest√µes no estilo CGA com gabarito e breve explica√ß√£o:">Gerar 10 quest√µes CGA</button>
                <button class="chip" data-q="Gere 10 quest√µes no estilo CGE com gabarito e breve explica√ß√£o:">Gerar 10 quest√µes CGE</button>
                <button class="chip" data-q="Explique juros compostos com exemplos e f√≥rmulas passo a passo:">Juros compostos (exemplos)</button>
                <button class="chip" data-q="Resolva uma quest√£o sobre taxa efetiva anual e explique o passo a passo:">Taxa efetiva anual ‚Äî resolver</button>
                <button class="chip" data-q="Crie um plano de estudos de 4 semanas para CPA-20 com foco em produtos e riscos:">Plano de estudos CPA‚Äë20 (4 semanas)</button>
            </div>

            <div class="controls">
                <div class="input-area">
                    <textarea 
                        id="user-input" 
                        placeholder="Ex: 'Explique juros compostos' ou 'Gerar simulado CPA-10'" 
                        aria-label="Mensagem"
                        rows="1"
                    ></textarea>
                    <button class="btn" id="send-btn">
                        <svg><use href="#send"/></svg>
                        Enviar
                    </button>
                </div>
                <button class="btn secondary" id="clear-btn" title="Limpar conversa">
                    <svg><use href="#clear"/></svg>
                </button>
            </div>
        </main>

            <aside id="study-sidebar" aria-label="Guia de certifica√ß√µes">
                <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
                    <div class="sidebar-title">Guia de Certifica√ß√µes</div>
                    <div style="display:flex;gap:6px;align-items:center">
                        <!-- link removido: mantemos o link oficial no cabe√ßalho conforme solicitado -->
                    </div>
                </div>
                <div class="cert-item">
                    <button class="toggle-cert" data-cert="CPA-10">CPA-10 ‚ñ∏</button>
                    <div class="module-list" data-cert-list="CPA-10" style="display:none">
                        <div class="module"><div>Fundamentos de Investimentos</div><button class="start" data-cert="CPA-10" data-module="1">Iniciar</button></div>
                        <div class="module"><div>Renda Fixa</div><button class="start" data-cert="CPA-10" data-module="2">Iniciar</button></div>
                        <div class="module"><div>Renda Vari√°vel</div><button class="start" data-cert="CPA-10" data-module="3">Iniciar</button></div>
                        <div class="module"><div>√âtica e Conduta</div><button class="start" data-cert="CPA-10" data-module="4">Iniciar</button></div>
                    </div>
                </div>

                <div class="cert-item">
                    <button class="toggle-cert" data-cert="CPA-20">CPA-20 ‚ñ∏</button>
                    <div class="module-list" data-cert-list="CPA-20" style="display:none">
                        <div class="module"><div>Produtos de Investimento</div><button class="start" data-cert="CPA-20" data-module="1">Iniciar</button></div>
                        <div class="module"><div>Gest√£o de Risco</div><button class="start" data-cert="CPA-20" data-module="2">Iniciar</button></div>
                        <div class="module"><div>Fundos e Carteiras</div><button class="start" data-cert="CPA-20" data-module="3">Iniciar</button></div>
                        <div class="module"><div>Planejamento Financeiro</div><button class="start" data-cert="CPA-20" data-module="4">Iniciar</button></div>
                    </div>
                </div>

                <div class="cert-item">
                    <button class="toggle-cert" data-cert="CEA">CEA ‚ñ∏</button>
                    <div class="module-list" data-cert-list="CEA" style="display:none">
                        <div class="module"><div>Produtos de Investimento Avan√ßados</div><button class="start" data-cert="CEA" data-module="1">Iniciar</button></div>
                        <div class="module"><div>Regula√ß√£o e Compliance</div><button class="start" data-cert="CEA" data-module="2">Iniciar</button></div>
                        <div class="module"><div>Gest√£o de Patrim√¥nio</div><button class="start" data-cert="CEA" data-module="3">Iniciar</button></div>
                    </div>
                </div>

                <div class="cert-item">
                    <button class="toggle-cert" data-cert="CFG">CFG ‚ñ∏</button>
                    <div class="module-list" data-cert-list="CFG" style="display:none">
                        <div class="module"><div>Conceitos Financeiros B√°sicos</div><button class="start" data-cert="CFG" data-module="1">Iniciar</button></div>
                        <div class="module"><div>Matem√°tica Financeira</div><button class="start" data-cert="CFG" data-module="2">Iniciar</button></div>
                    </div>
                </div>

                <div class="cert-item">
                    <button class="toggle-cert" data-cert="CGA">CGA ‚ñ∏</button>
                    <div class="module-list" data-cert-list="CGA" style="display:none">
                        <div class="module"><div>An√°lise de Risco</div><button class="start" data-cert="CGA" data-module="1">Iniciar</button></div>
                        <div class="module"><div>Instrumentos Derivativos</div><button class="start" data-cert="CGA" data-module="2">Iniciar</button></div>
                    </div>
                </div>

                <div class="cert-item">
                    <button class="toggle-cert" data-cert="CGE">CGE ‚ñ∏</button>
                    <div class="module-list" data-cert-list="CGE" style="display:none">
                        <div class="module"><div>Gest√£o de Empresas</div><button class="start" data-cert="CGE" data-module="1">Iniciar</button></div>
                        <div class="module"><div>Contabilidade e Demonstra√ß√µes</div><button class="start" data-cert="CGE" data-module="2">Iniciar</button></div>
                    </div>
                </div>
            </aside>
        </div>

    <script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');
    // N√£o exibimos a URL da API no HTML; mantemos internamente para chamadas
    const API_URL = 'https://psychic-waddle-969r9rp75553xr-5000.app.github.dev/api/chat';

        // Escapa texto para evitar XSS e aplica formata√ß√£o simples para **negrito**
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatMessage(text){
            // transforma **texto** em <strong>
            const escaped = escapeHtml(text);
            return escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        function addMessage(kind, rawText) {
            const wrap = document.createElement('div');
            wrap.className = 'msg-wrap ' + kind;

            // Avatar (cria via innerHTML para compatibilidade)
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            const icon = kind === 'user' ? 'user' : 'robot';
            avatar.innerHTML = `<svg aria-hidden="true"><use href="#${icon}"></use></svg>`;
            wrap.appendChild(avatar);

            // Mensagem
            const msg = document.createElement('div');
            msg.className = 'msg';
            msg.innerHTML = formatMessage(rawText.replace('Voc√™:', '').replace('IA (Flask):', ''));

            // Timestamp
            const meta = document.createElement('span');
            meta.className = 'meta';
            const ts = new Date();
            meta.textContent = ts.toLocaleTimeString();
            msg.appendChild(meta);

            wrap.appendChild(msg);
            chatBox.appendChild(wrap);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function setTyping(on){
            const id = 'typing-indicator';
            let el = document.getElementById(id);
            if(on){
                if(!el){
                    el = document.createElement('div');
                    el.id = id;
                    el.className = 'msg-wrap system typing';
                    el.innerHTML = `<div class="msg">IA est√° escrevendo... <span class="meta"></span></div>`;
                    chatBox.appendChild(el);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            } else {
                if(el) el.remove();
            }
        }

        async function sendMessage(){
            const text = userInput.value.trim();
            if(!text) return;

            addMessage('user', 'Voc√™: **' + text + '**');
            userInput.value = '';
            sendBtn.disabled = true;
            setTyping(true);

            try{
                const controller = new AbortController();
                // timeout 20s
                const timeout = setTimeout(()=>controller.abort(), 20000);

                const resp = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({message: text}),
                    signal: controller.signal
                });
                clearTimeout(timeout);

                if(!resp.ok){
                    throw new Error('Status ' + resp.status);
                }
                const data = await resp.json();
                addMessage('ai', (data.response||'Sem resposta do servidor').toString());

            } catch(err){
                console.error(err);
                addMessage('error', 'üö® Erro de comunica√ß√£o: ' + (err.message || String(err)));
            } finally{
                setTyping(false);
                sendBtn.disabled = false;
            }
        }

        // Fun√ß√£o para resetar o chat para estado inicial
        function resetChat(){
            chatBox.innerHTML = `
                <div class="msg-wrap system">
                    <div class="msg">
                        <span style="color:#0ea5a4">üëã Bem-vindo!</span><br>
                        Sou um assistente para ajud√°-lo a estudar para certifica√ß√µes Anbima (CPA-10, CPA-20, CEA).<br>
                        Pe√ßa quest√µes de simulado, explica√ß√µes de conceitos (juros, renda fixa, fundos) ou planos de estudo.
                    </div>
                </div>`;
            userInput.focus();
        }

        // Eventos
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', resetChat);

        // Enter envia, Shift+Enter nova linha
        userInput.addEventListener('keydown', function(e){
            if(e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize do textarea
        function autoResize(){
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        }
        userInput.addEventListener('input', autoResize);

        // Fun√ß√£o para inserir texto a partir das perguntas r√°pidas
        function insertQuickText(text){
            userInput.value = text;
            // atualiza altura do textarea
            autoResize.call(userInput);
            userInput.focus();
            // posiciona ao final
            userInput.selectionStart = userInput.selectionEnd = userInput.value.length;
        }

        // Antes: handlers individuais. Agora usamos delega√ß√£o de eventos para
        // garantir que bot√µes recriados dinamicamente continuem funcionando.
        document.addEventListener('click', (ev)=>{
            const btn = ev.target.closest && ev.target.closest('button');
            if(!btn) return;

            // Perguntas r√°pidas (chips acima do input)
            if(btn.closest('.quick-questions')){
                const q = btn.dataset.q;
                if(q) insertQuickText(q);
                return;
            }

            // Note: view-mode buttons were removed from the DOM; viewMode stays
            // as 'modules' by default. If we add controls later, handle them here.

            // Toggle das certifica√ß√µes (abre/fecha a lista)
            if(btn.classList.contains('toggle-cert')){
                const cert = btn.dataset.cert;
                const list = document.querySelector(`[data-cert-list="${cert}"]`);
                if(!list) return;
                const open = list.style.display !== 'none';
                document.querySelectorAll('.module-list').forEach(l=> l.style.display = 'none');
                list.style.display = open ? 'none' : 'block';
                return;
            }

            // Iniciar m√≥dulo (bot√µes dentro das listas geradas dinamicamente)
            if(btn.classList.contains('start')){
                const cert = btn.dataset.cert;
                const idx = parseInt(btn.dataset.module);
                if(cert && idx) startModule(cert, idx);
                return;
            }
        });

        // Plans and cert order (global)
        const CERT_ORDER = ['CPA-10','CPA-20','CEA','CFG','CGA','CGE'];
        const PLANS = {
            'CPA-10': [
                'Fundamentos de Investimentos: conceitos b√°sicos, produtos e institui√ß√µes',
                'Renda Fixa: tipos, indexadores (pr√©, p√≥s, IPCA), riscos e c√°lculo de retorno',
                'Renda Vari√°vel: a√ß√µes, √≠ndices, an√°lise b√°sica e riscos',
                'Fundos de Investimento: estrutura, taxas, classes e funcionamento',
                'Produtos Banc√°rios e Previd√™ncia: CDB, LC, LCI/LCA, previd√™ncia privada',
                '√âtica e Conduta: c√≥digo de conduta, suitability e regula√ß√£o'
            ],
            'CPA-20': [
                'Produtos de Investimento: fundos, previd√™ncia, COE, estruturados',
                'Gest√£o de Risco: medidas (VaR, stress), mitiga√ß√£o, aloca√ß√£o',
                'Fundos e Carteiras: tipos, pol√≠ticas, an√°lise de desempenho e taxas',
                'Planejamento Financeiro: cen√°rios, objetivos, impostos e solu√ß√µes',
                'Derivativos b√°sicos aplicados √† gest√£o de risco (vis√£o pr√°tica)'
            ],
            'CEA': [
                'Produtos Avan√ßados: estrat√©gias, carteiras e produtos estruturados',
                'Regula√ß√£o e Compliance: normas, responsabilidades e governan√ßa',
                'Gest√£o de Patrim√¥nio: aloca√ß√£o estrat√©gica, suitability e revis√£o',
                'Tributa√ß√£o e Produtos: implica√ß√µes fiscais em diferentes produtos'
            ],
            'CFG': [
                'Conceitos Financeiros B√°sicos: juros, infla√ß√£o, rentabilidade, no√ß√µes do SFN',
                'Matem√°tica Financeira: juros simples e compostos, descontos e equival√™ncia',
                'Produtos b√°sicos e funcionamento do mercado'
            ],
            'CGA': [
                'An√°lise de Risco: m√©tricas, modelos e avalia√ß√£o de risco de cr√©dito e mercado',
                'Instrumentos Derivativos: futuros, op√ß√µes, swaps (conceitos e uso)',
                'Mercado de Capitais: opera√ß√µes, estrutura e participantes'
            ],
            'CGE': [
                'Conceitos do Sistema Financeiro Nacional: estrutura, institui√ß√µes e √≥rg√£os reguladores',
                'Produtos e Mercados: renda fixa, renda vari√°vel, c√¢mbio e derivativos',
                'Contabilidade e Demonstra√ß√µes: balan√ßo, DRE, indicadores e an√°lise',
                'Finan√ßas Corporativas: valuation, or√ßamento de capital, an√°lise de investimentos',
                'Governan√ßa Corporativa e Compliance: estruturas, responsabilidades e ag√™ncia',
                'Gest√£o de Risco e Controle Interno: identifica√ß√£o, mitiga√ß√£o e m√©tricas',
                'Aspectos Tribut√°rios e Regulat√≥rios relevantes para empresas'
            ]
        };

        // render module list depending on view mode
        let viewMode = 'modules'; // 'modules' | 'diff' | 'all'

        function renderModuleList(cert){
            const container = document.querySelector(`[data-cert-list="${cert}"]`);
            if(!container) return;
            const items = PLANS[cert] || [];
            let toShow = [];
            if(viewMode === 'modules' || viewMode === 'all'){
                toShow = items.slice();
            } else if(viewMode === 'diff'){
                const idx = CERT_ORDER.indexOf(cert);
                if(idx > 0){
                    const prev = CERT_ORDER[idx-1];
                    const prevItems = new Set(PLANS[prev] || []);
                    toShow = items.filter(it => !prevItems.has(it));
                } else {
                    toShow = items.slice();
                }
            }
            // if viewMode == 'all' we could include cross-cert extras; for now same as modules
            container.innerHTML = '';
            if(toShow.length === 0){
                container.innerHTML = '<div style="color:var(--muted);font-size:13px">(Nenhum t√≥pico novo)</div>';
            } else {
                toShow.forEach((txt, i)=>{
                    const div = document.createElement('div');
                    div.className = 'module';
                    div.innerHTML = `<div>${txt}</div><button class="start" data-cert="${cert}" data-module="${i+1}">Iniciar</button>`;
                    container.appendChild(div);
                });
            }
            // Notas: n√£o anexamos handlers individuais aqui porque usamos
            // delega√ß√£o global de eventos (document.addEventListener('click', ...)).
        }

        function updateAllModuleLists(){
            CERT_ORDER.forEach(cert=> renderModuleList(cert));
        }

        // Start module: insert a study plan message and focus
        function startModule(cert, moduleIndex){
            const txt = (PLANS[cert] && PLANS[cert][moduleIndex-1]) ? PLANS[cert][moduleIndex-1] : `M√≥dulo ${moduleIndex} ‚Äî Plano de estudos para ${cert}`;
            addMessage('system', `Plano de estudo selecionado ‚Äî ${cert}: ${txt}`);
            insertQuickText(`Quero come√ßar: ${cert} ‚Äî ${txt}\n\nPor favor, detalhe o conte√∫do, exerc√≠cios e fontes de estudo.`);
        }

        // initialize lists
        updateAllModuleLists();

    // (handlers para view buttons agora s√£o feitos por delega√ß√£o de eventos acima)

        // Ajuda ao abrir: foca o textarea e inicializa
        window.addEventListener('load', ()=>{ resetChat(); userInput.focus(); });

        // Theme toggle logic: aplica classe 'dark' ao body e persiste em localStorage
        const themeToggle = document.getElementById('theme-toggle');
        function applyTheme(t){
            if(t === 'dark'){
                document.body.classList.add('dark');
                themeToggle.setAttribute('aria-pressed','true');
                themeToggle.setAttribute('aria-label','Tema: Escuro');
            } else {
                document.body.classList.remove('dark');
                themeToggle.setAttribute('aria-pressed','false');
                themeToggle.setAttribute('aria-label','Tema: Claro');
            }
        }

        // Inicializa a partir do localStorage (ou preferencia do sistema)
        const stored = localStorage.getItem('chat_theme');
        if(stored){ applyTheme(stored); }
        else {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(prefersDark ? 'dark' : 'light');
        }

        themeToggle.addEventListener('click', ()=>{
            const isDark = document.body.classList.contains('dark');
            const next = isDark ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem('chat_theme', next);
        });
    </script>
</body>
</html>
